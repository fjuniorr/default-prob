library(stringr); library(purrr)

valid_tokens <- c("+", "-", "...", "")

foo <- c(" (2+109-165+175+176)", " (4+16+19)", " (26+ ... +33)", " (Receita Total - Despesa Total)")


rec <- c(" (2+109-165+175+176)", " (3+20+23+37+38+39+40+102)", " (4+16+19)", 
  " (5+13)", " (6+7+10+11+12)", " (8+9)", " (14+15)", " (17+18)", 
  " (21+22)", " (24+25+34+35+36)", " (26+ ... +33)", " (41+76+77+78+79+97)", 
  " (42+64+68+72)", " (43+50+58+59+60+61+62+63)", " (44+ ... +49)", 
  " (51+ ... +57)", " (65+66+67)", " (69+70+71)", " (73+74+75)", 
  " (80+87+91+95+96)", " (81+ ... +86)", " (88+89+90)", " (92+93+94)", 
  " (98+ ... +101)", " (103+104+105+108)", " (106+107)", " (110+113+116+117+164)", 
  " (111+112)", " (114+115)", " (118+134+135+136+137+138+159)", 
  " (119+124+129)", " (120+121+122+123)", " (125+126+127+128)", 
  " (130+131+132+133)", " (139+146+153+157+158)", " (140+ ... +145)", 
  " (147+ ... +152)", " (154+155+156)", " (160+161+162+163)", " (166+167+168+169)", 
  " (170+171+172+173+174)")


desp <- c(" (2+85)", " (3+27+37)", " (4+5+6+7+8+9+26)", " (10+ ... +25)", 
  " (28)", " (29+ ... +36)", " (38+ ... +46+84)", " (47+ ... +83)", 
  " (86+113+133)", " (87+ ... +95+112)", " (96+ ... +111)", " (114+ ... +121+132)", 
  " (122+ ... +131)", " (134)", " (135+ ... +144)", " (Receita Total - Despesa Total)"
)

parse_memoria <- function(x) {
    tmp <- x %>% map(str_replace_all, "\\s", "") %>% 
        map(str_replace_all, "\\(", "+") %>% 
        map(str_replace_all, "\\)", "") %>% 
        map(~ gsub("\\+", "\\1_+", .x)) %>% 
        map(~ gsub("-", "\\1_-", .x)) %>% 
        map(~ unlist(str_split(.x, "_"))) %>% 
        map(~ .x[.x != ""]) %>% 
        map(make_seq)
    
    sign <- tmp %>% 
        str_extract_all("\\+|-") %>% 
        unlist
    
    index <- tmp %>% 
        map(~ gsub("\\+|-", "", .x)) %>% 
        map(as.numeric) %>% 
        unlist
    
    list(sign = sign, index = index)
}

make_seq <- function(x) {
    dot_index <- which(grepl("\\.\\.\\.", x))
    
    ret <- x
    
    if(length(dot_index) == 1) {
        from <- x[dot_index-1] %>% gsub("\\+|-", "", .) %>% as.numeric() + 1
        to <- x[dot_index+1] %>% gsub("\\+|-", "", .) %>% as.numeric() - 1
        
        ret <- c(
            x[1:(dot_index-1)],
            paste0("+",seq(from = from, to = to)),
            x[(dot_index+1):length(x)])    
    }
    ret
}
